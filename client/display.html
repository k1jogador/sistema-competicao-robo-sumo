<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Torneio Oficial - Slim Display</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./styles/display.css" />
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div id="live-screen">
      <header>
        <div class="round-badge" id="display-round">Round 1</div>
      </header>

      <main class="match-area">
        <div class="player-card blue">
          <div class="player-score" id="score1">0</div>
          <div class="player-name" id="name1">Azul</div>
        </div>

        <div class="timer-container" id="timer-box">
          <div class="timer-display" id="display-time">00:00</div>
          <div class="timer-label">Tempo Restante</div>
          <div
            class="status-badge paused-anim"
            id="paused-indicator"
            style="margin-top: 20px; text-align: center"
          >
            PAUSADO
          </div>
        </div>

        <div class="player-card red">
          <div class="player-score" id="score2">0</div>
          <div class="player-name" id="name2">Vermelho</div>
        </div>
      </main>

      <footer>
        <button id="audio-btn" onclick="enableAudio()">
          Ativar Som do gongo
        </button>
      </footer>
    </div>

    <div id="history-screen" class="hidden">
      <div class="bracket-container">
        <div class="phase-column" id="col-fase1">
          <div class="phase-title">Classificatórias</div>
        </div>
        <div class="phase-column" id="col-semi">
          <div class="phase-title">Semifinais</div>
        </div>
        <div class="phase-column final" id="col-final">
          <div class="phase-title">Grande Final</div>
        </div>
      </div>
    </div>

    <script>
      const socket = io();
      // Som de gongo mais profissional (exemplo)
      const audio = new Audio(
        'https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8c8a7346b.mp3?filename=boxing-bell-1-6331.mp3',
      );
      let audioEnabled = false;

      function enableAudio() {
        audio
          .play()
          .then(() => {
            audio.pause();
            audio.currentTime = 0;
            audioEnabled = true;
            document.getElementById('audio-btn').style.display = 'none';
          })
          .catch((e) => console.log('Clique para ativar o som'));
      }

      socket.on('update-display', (data) => {
        if (data.viewMode === 'HISTORY') {
          document.getElementById('live-screen').classList.add('hidden');
          document.getElementById('history-screen').classList.remove('hidden');
          return;
        } else {
          document.getElementById('live-screen').classList.remove('hidden');
          document.getElementById('history-screen').classList.add('hidden');
        }

        // Atualiza dados
        document.getElementById('display-time').innerText = formatTime(
          data.time,
        );
        document.getElementById('name1').innerText = data.nome1 || 'Azul';
        document.getElementById('name2').innerText = data.nome2 || 'Vermelho';
        document.getElementById('score1').innerText = data.score1;
        document.getElementById('score2').innerText = data.score2;
        document.getElementById('display-round').innerText =
          'Round ' + data.round;

        // Pausa
        const elPaused = document.getElementById('paused-indicator');
        if (data.isPaused) elPaused.style.display = 'block';
        else elPaused.style.display = 'none';

        // Timer ended aesthetic
        const timerBox = document.getElementById('timer-box');
        if (data.time === 0 && !data.isRunning) timerBox.classList.add('ended');
        else timerBox.classList.remove('ended');
      });

      socket.on('timer-finished', () => {
        if (audioEnabled) {
          audio.currentTime = 0;
          audio.play();
        }
      });

      function formatTime(s) {
        return (
          Math.floor(s / 60)
            .toString()
            .padStart(2, '0') +
          ':' +
          (s % 60).toString().padStart(2, '0')
        );
      }

      function createMatchCard(match) {
        // Card "Bye" Slim
        if (!match.nome2 || match.nome2 === '-' || match.nome2 === '') {
          return `
            <div class="match-card bye-card">
                <div class="bye-label">Classificado Direto</div>
                <div class="team-row" style="justify-content: center;">
                    <span class="team-name" style="font-weight: 400; color: "#fff";">${match.nome1}</span>
                </div>
            </div>`;
        }

        // Card Normal Slim
        const w1 = match.score1 > match.score2 ? 'winner-text' : '';
        const w2 = match.score2 > match.score1 ? 'winner-text' : '';
        return `
            <div class="match-card">
                <div class="team-row"><span class="team-name ${w1}">${match.nome1}</span><span class="team-score ${w1}">${match.score1}</span></div>
                <div style="height:1px; background:#333; margin: 4px 0;"></div>
                <div class="team-row"><span class="team-name ${w2}">${match.nome2}</span><span class="team-score ${w2}">${match.score2}</span></div>
            </div>`;
      }

      socket.on('update-history', (matches) => {
        const cols = {
          preliminar: document.getElementById('col-fase1'),
          quartas: document.getElementById('col-fase1'),
          semi: document.getElementById('col-semi'),
          final: document.getElementById('col-final'),
        };

        if (!cols.preliminar || !cols.semi || !cols.final) return;

        // Títulos limpos
        cols.preliminar.innerHTML =
          '<div class="phase-title">Classificatórias</div>';
        cols.semi.innerHTML = '<div class="phase-title">Semifinais</div>';
        cols.final.innerHTML = '<div class="phase-title">Grande Final</div>';

        matches.forEach((m) => {
          const cardHTML = createMatchCard(m);
          if (cols[m.fase]) {
            cols[m.fase].innerHTML += cardHTML;
          }
        });
      });
    </script>
  </body>
</html>
